<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GAME.IT</title>
    <link rel="icon" href="/assets/favicon.svg" />
    <link rel="stylesheet" href="/css/styles.css" />
    <script>
      function wllogout() {
        fetch("/api/whitelist/logout", {
          method: "POST",
          credentials: "include",
        })
          .then((r) => r.json())
          .then((data) => {
            if (data.ok) {
              window.location.reload();
            } else {
              alert("whitelist logout fail: " + (data.error || "unknown"));
            }
          })
          .catch((err) => {
            console.error("logout err:", err);
            alert("logout JS error");
          });
      }
    </script>
  </head>

  <body class="no-sidebar-desktop">
    <!-- topbar -->
    <header class="topbar">
      <div class="topbar__left">
        <div class="brand">
          <svg width="28" height="28" viewBox="0 0 24 24" aria-hidden="true">
            <circle cx="12" cy="12" r="10" fill="currentColor" opacity="0.9"></circle>
            <circle cx="12" cy="12" r="4" fill="black" opacity="0.7"></circle>
          </svg>
          <span class="brand__text">GAME.IT</span>
        </div>

        <!-- Mobile burger -->
        <button id="mobileMenuBtn" class="burger" aria-label="Open menu">
          <span></span><span></span><span></span>
        </button>

        <nav class="nav">
          <button
            class="nav__link active"
            data-route="store"
            onclick="window.location='/'"
          >
            Underground
          </button>
          <button
            class="nav__link"
            data-route="library"
            onclick="window.location='/library'"
          >
            Library
          </button>
          <button
            class="nav__link"
            data-route="community"
            onclick="window.location='/community'"
          >
            Community
          </button>
          <button
            class="nav__link trusted"
            data-route="trusted"
            onclick="window.location='/trusted'"
          >
            Trusted ❤️
          </button>
          <button class="nav__link" data-route="community" onclick="wllogout()">
            WL Logout
          </button>
        </nav>
      </div>

      <div class="topbar__right">
        <div class="search">
          <input id="searchInput" type="search" placeholder="Search games…" />
        </div>
        <!-- mount point for auth UI (JS will inject everything here) -->
        <div id="auth-root"></div>
      </div>
    </header>

    <!-- Backdrop for mobile drawer -->
    <div id="sidebarBackdrop" class="sidebar-backdrop" hidden></div>

    <!-- layout -->
    <div class="layout">
      <aside class="sidebar" id="mobileDrawer">
        <nav class="mnav" aria-label="Main">
          <div class="mnav__section">
            <div class="mnav__title">Menu</div>
            <a class="mnav__item" href="/">Games</a>
            <a class="mnav__item" href="/library">Library</a>
            <a class="mnav__item" href="/community">Community</a>
            <a class="mnav__item" href="/trusted">Trusted ❤️</a>
            <button id="mnav-logout" class="mnav__item mnav__btn" type="button">
              Whitelist logout
            </button>
          </div>
        </nav>
      </aside>

      <main class="content">
        <section class="hero">
          <div class="hero__bg"></div>
          <div class="hero__content">
            <h1>This is the future of GAMING: GameIt!</h1>
            <p>
              Find a game of any genre from the browser of supported sites. But
              beware – at your <u>own risk</u>!
            </p>
          </div>
        </section>

        <section class="shelf">
          <div class="shelf__header">
            <h2>Games</h2>
            <!-- Mobile filters (shown only on phones) -->
            <div class="filters-mobile" aria-label="Mobile filters">
              <div class="fm-row">
                <!-- SOURCE -->
                <div class="fm-col">
                  <button id="btnSource" class="fm-btn" type="button">
                    Source:
                  </button>
                  <div id="menuSource" class="fm-menu" hidden>
                    <button class="fm-menu__item" data-src="ALL">ALL</button>
                    <button class="fm-menu__item" data-src="Anker">
                      Anker
                    </button>
                    <button class="fm-menu__item" data-src="RepackGames">
                      Repack
                    </button>
                    <button class="fm-menu__item" data-src="OnlineFix">
                      OnlineFix
                    </button>
                    <button class="fm-menu__item" data-src="Game3RB">
                      Game3RB
                    </button>
                    <button class="fm-menu__item" data-src="SteamUnderground">
                      SteamUnd.
                    </button>
                  </div>
                </div>

                <!-- SORT -->
                <div class="fm-col">
                  <button id="btnSort" class="fm-btn" type="button">
                    Sort by:
                  </button>
                  <div id="menuSort" class="fm-menu" hidden>
                    <button class="fm-menu__item" data-sort="default">
                      Default
                    </button>
                    <button class="fm-menu__item" data-sort="name-asc">
                      Name (A-Z)
                    </button>
                    <button class="fm-menu__item" data-sort="name-desc">
                      Name (Z-A)
                    </button>
                    <button class="fm-menu__item" data-sort="source-asc">
                      Source (A-Z)
                    </button>
                    <button class="fm-menu__item" data-sort="source-desc">
                      Source (Z-A)
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="cards" id="cardGrid"></div>
        </section>
      </main>
    </div>

    <!-- game modal -->
    <div id="gameModal" class="modal" hidden>
      <div class="modal__dialog">
        <button id="modalClose" class="modal__close" aria-label="Close">
          ×
        </button>
        <div id="modalBody" class="modal__body"></div>
      </div>
    </div>

    <script src="/js/app.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/mobile_menu.js"></script>
    
    <script>
      //---Filter-source-sort-menu---//
      (function () {
        const btnSource = document.getElementById("btnSource");
        const menuSource = document.getElementById("menuSource");
        const btnSort = document.getElementById("btnSort");
        const menuSort = document.getElementById("menuSort");

        const srcFilterBar = document.getElementById("srcFilter");
        const sortSelect = document.getElementById("sortSelect");

        function toggleMenu(btn, menu, open) {
          if (!btn || !menu) return;
          const willOpen =
            typeof open === "boolean" ? open : menu.hasAttribute("hidden");
          if (willOpen) {
            btn.classList.add("is-open");
            menu.removeAttribute("hidden");
          } else {
            btn.classList.remove("is-open");
            menu.setAttribute("hidden", "");
          }
        }

        if (btnSource && menuSource) {
          btnSource.addEventListener("click", (e) => {
            e.stopPropagation();
            if (btnSort && menuSort) toggleMenu(btnSort, menuSort, false);
            toggleMenu(btnSource, menuSource);
          });
        }
        if (btnSort && menuSort) {
          btnSort.addEventListener("click", (e) => {
            e.stopPropagation();
            if (btnSource && menuSource)
              toggleMenu(btnSource, menuSource, false);
            toggleMenu(btnSort, menuSort);
          });
        }

        document.addEventListener("click", (e) => {
          const withinSource =
            btnSource &&
            (btnSource.contains(e.target) ||
              (menuSource && menuSource.contains(e.target)));
          const withinSort =
            btnSort &&
            (btnSort.contains(e.target) ||
              (menuSort && menuSort.contains(e.target)));
          if (!withinSource && btnSource && menuSource)
            toggleMenu(btnSource, menuSource, false);
          if (!withinSort && btnSort && menuSort)
            toggleMenu(btnSort, menuSort, false);
        });

        if (menuSource) {
          menuSource.addEventListener("click", (e) => {
            const item = e.target.closest(".fm-menu__item[data-src]");
            if (!item) return;
            const wanted = item.getAttribute("data-src");
            if (srcFilterBar) {
              const desktopBtn = srcFilterBar.querySelector(
                `button[data-src="${wanted}"]`
              );
              if (desktopBtn) desktopBtn.click();
              else if (window.setSourceFilter) window.setSourceFilter(wanted);
            } else if (window.setSourceFilter) {
              window.setSourceFilter(wanted);
            }
            toggleMenu(btnSource, menuSource, false);
          });
        }

        if (menuSort) {
          menuSort.addEventListener("click", (e) => {
            const item = e.target.closest(".fm-menu__item[data-sort]");
            if (!item) return;
            const val = item.getAttribute("data-sort");
            if (sortSelect) {
              sortSelect.value = val;
              sortSelect.dispatchEvent(new Event("change", { bubbles: true }));
            } else if (window.applySortToCards) {
              window.applySortToCards(val);
            }
            toggleMenu(btnSort, menuSort, false);
          });
        }
      })();
    </script>
  </body>
</html>
